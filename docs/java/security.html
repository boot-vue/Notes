<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Security ğŸŒ± | å•ªå•ªå•ªçš„æŒ‡é’ˆ</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/Notes/assets/css/0.styles.26d9167b.css" as="style"><link rel="preload" href="/Notes/assets/js/app.269e44a0.js" as="script"><link rel="preload" href="/Notes/assets/js/2.cc402b5a.js" as="script"><link rel="preload" href="/Notes/assets/js/6.f5678ca0.js" as="script"><link rel="prefetch" href="/Notes/assets/js/10.81ed7e0b.js"><link rel="prefetch" href="/Notes/assets/js/11.542d73d3.js"><link rel="prefetch" href="/Notes/assets/js/12.40802d17.js"><link rel="prefetch" href="/Notes/assets/js/13.ab5bc61f.js"><link rel="prefetch" href="/Notes/assets/js/14.36eb2886.js"><link rel="prefetch" href="/Notes/assets/js/15.5a41a7b1.js"><link rel="prefetch" href="/Notes/assets/js/16.bbba030c.js"><link rel="prefetch" href="/Notes/assets/js/17.7b591df4.js"><link rel="prefetch" href="/Notes/assets/js/18.0c413157.js"><link rel="prefetch" href="/Notes/assets/js/19.2e5c4834.js"><link rel="prefetch" href="/Notes/assets/js/20.663c3e4e.js"><link rel="prefetch" href="/Notes/assets/js/21.0e875a57.js"><link rel="prefetch" href="/Notes/assets/js/22.3504f0c2.js"><link rel="prefetch" href="/Notes/assets/js/23.f8c2eb7b.js"><link rel="prefetch" href="/Notes/assets/js/24.139bd347.js"><link rel="prefetch" href="/Notes/assets/js/25.a02e70ba.js"><link rel="prefetch" href="/Notes/assets/js/26.ecd71280.js"><link rel="prefetch" href="/Notes/assets/js/27.64759ab2.js"><link rel="prefetch" href="/Notes/assets/js/28.3248fd5a.js"><link rel="prefetch" href="/Notes/assets/js/29.f7ec7e49.js"><link rel="prefetch" href="/Notes/assets/js/3.cad87ac4.js"><link rel="prefetch" href="/Notes/assets/js/30.050f242f.js"><link rel="prefetch" href="/Notes/assets/js/31.adb14bd2.js"><link rel="prefetch" href="/Notes/assets/js/32.3cdebf6d.js"><link rel="prefetch" href="/Notes/assets/js/33.8de8c4f2.js"><link rel="prefetch" href="/Notes/assets/js/34.129599d3.js"><link rel="prefetch" href="/Notes/assets/js/35.76ff9a0b.js"><link rel="prefetch" href="/Notes/assets/js/36.03eb666b.js"><link rel="prefetch" href="/Notes/assets/js/37.104e61e7.js"><link rel="prefetch" href="/Notes/assets/js/38.e8bb0b7c.js"><link rel="prefetch" href="/Notes/assets/js/39.88ea7189.js"><link rel="prefetch" href="/Notes/assets/js/4.04a3f9a2.js"><link rel="prefetch" href="/Notes/assets/js/40.2c16f98e.js"><link rel="prefetch" href="/Notes/assets/js/41.e1386553.js"><link rel="prefetch" href="/Notes/assets/js/42.016b4dd1.js"><link rel="prefetch" href="/Notes/assets/js/43.da91a5f7.js"><link rel="prefetch" href="/Notes/assets/js/5.32820f9e.js"><link rel="prefetch" href="/Notes/assets/js/7.ee19f2e3.js"><link rel="prefetch" href="/Notes/assets/js/8.2905ec11.js"><link rel="prefetch" href="/Notes/assets/js/9.283e18f5.js">
    <link rel="stylesheet" href="/Notes/assets/css/0.styles.26d9167b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Notes/" class="home-link router-link-active"><!----> <span class="site-name">å•ªå•ªå•ªçš„æŒ‡é’ˆ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Notes/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/Notes/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/Notes/hadoop/" class="nav-link">
  Hadoop
</a></div><div class="nav-item"><a href="/Notes/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/Notes/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/Notes/open/" class="nav-link">
  å¥½å·¥å…·
</a></div><div class="nav-item"><a href="/Notes/sharp/" class="nav-link">
  åˆ©å™¨
</a></div><div class="nav-item"><a href="/Notes/web/" class="nav-link">
  å‰ç«¯ | APP
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ‚ä¸ƒæ‚å…«" class="dropdown-title"><span class="title">æ‚ä¸ƒæ‚å…«</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ‚ä¸ƒæ‚å…«" class="mobile-dropdown-title"><span class="title">æ‚ä¸ƒæ‚å…«</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          è¦å¤šæ‚æœ‰å¤šæ‚
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notes/notes/setting.html" class="nav-link">
  å¸¸ç”¨é…ç½®
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/shell.html" class="nav-link">
  Shell
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/other.html" class="nav-link">
  å…¶å®ƒ
</a></li></ul></li><li class="dropdown-item"><h4>
          æˆ‘çš„ç ´çƒ‚~
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notes/notes/xianyu.html" class="nav-link">
  å¥½ä¸œè¥¿å•Š
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/boot-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Notes/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/Notes/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/Notes/hadoop/" class="nav-link">
  Hadoop
</a></div><div class="nav-item"><a href="/Notes/go/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/Notes/python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/Notes/open/" class="nav-link">
  å¥½å·¥å…·
</a></div><div class="nav-item"><a href="/Notes/sharp/" class="nav-link">
  åˆ©å™¨
</a></div><div class="nav-item"><a href="/Notes/web/" class="nav-link">
  å‰ç«¯ | APP
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ‚ä¸ƒæ‚å…«" class="dropdown-title"><span class="title">æ‚ä¸ƒæ‚å…«</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ‚ä¸ƒæ‚å…«" class="mobile-dropdown-title"><span class="title">æ‚ä¸ƒæ‚å…«</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          è¦å¤šæ‚æœ‰å¤šæ‚
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notes/notes/setting.html" class="nav-link">
  å¸¸ç”¨é…ç½®
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/shell.html" class="nav-link">
  Shell
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/Notes/notes/other.html" class="nav-link">
  å…¶å®ƒ
</a></li></ul></li><li class="dropdown-item"><h4>
          æˆ‘çš„ç ´çƒ‚~
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notes/notes/xianyu.html" class="nav-link">
  å¥½ä¸œè¥¿å•Š
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/boot-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Newä¸€ä¸ªå¯¹è±¡</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Notes/java/" aria-current="page" class="sidebar-link">Java ğŸ”</a></li><li><a href="/Notes/java/guava.html" class="sidebar-link">å‘±å‘±å‘±~</a></li><li><a href="/Notes/java/kotlin.html" class="sidebar-link">Kotlin ğŸ“</a></li><li><a href="/Notes/java/gradle.html" class="sidebar-link">Gradle</a></li><li><a href="/Notes/java/flowable.html" class="sidebar-link">flowable</a></li><li><a href="/Notes/java/dubbo.html" class="sidebar-link">Dubbo ğŸ’</a></li><li><a href="/Notes/java/cloud.html" class="sidebar-link">Spring Cloud â˜ï¸ (alibaba)</a></li><li><a href="/Notes/java/security.html" aria-current="page" class="active sidebar-link">Security ğŸŒ±</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notes/java/security.html#httpsecurity" class="sidebar-link">HttpSecurity</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#userdetailsservice" class="sidebar-link">UserDetailsService</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#passwordencoder" class="sidebar-link">PasswordEncoder</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#è‡ªå®šä¹‰ç™»å½•" class="sidebar-link">è‡ªå®šä¹‰ç™»å½•</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#è®¤è¯æµç¨‹" class="sidebar-link">è®¤è¯æµç¨‹</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#è‡ªå®šä¹‰è®¤è¯" class="sidebar-link">è‡ªå®šä¹‰è®¤è¯</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#æˆæƒ" class="sidebar-link">æˆæƒ</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#shiro" class="sidebar-link">Shiro</a></li><li class="sidebar-sub-header"><a href="/Notes/java/security.html#google-authenticator" class="sidebar-link">Google Authenticator</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="security-ğŸŒ±"><a href="#security-ğŸŒ±" class="header-anchor">#</a> Security ğŸŒ±</h1> <p>æ ¸å¿ƒ:ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨é“¾</p> <p>æ ¸å¿ƒè¿‡æ»¤å™¨é“¾é¡ºåº:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelProcessingFilter</span><span class="token punctuation">,</span> because it might need <span class="token keyword">to</span> <span class="token namespace">redirect</span> <span class="token keyword">to</span> <span class="token namespace">a</span> different protocol
<span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">,</span> so a <span class="token class-name">SecurityContext</span> can be set up in the <span class="token class-name">SecurityContextHolder</span> at the beginning of a web request<span class="token punctuation">,</span> and any changes <span class="token keyword">to</span> <span class="token namespace">the</span> <span class="token class-name">SecurityContext</span> can be copied <span class="token keyword">to</span> <span class="token namespace">the</span> <span class="token class-name">HttpSession</span> when the web request ends <span class="token punctuation">(</span>ready <span class="token keyword">for</span> use <span class="token keyword">with</span> <span class="token namespace">the</span> next web request<span class="token punctuation">)</span>
<span class="token class-name">ConcurrentSessionFilter</span><span class="token punctuation">,</span> because it <span class="token keyword">uses</span> <span class="token namespace">the</span> <span class="token class-name">SecurityContextHolder</span> functionality and needs <span class="token keyword">to</span> <span class="token namespace">update</span> the <span class="token class-name">SessionRegistry</span> <span class="token keyword">to</span> <span class="token namespace">reflect</span> ongoing requests from the principal
<span class="token class-name">Authentication</span> processing mechanisms <span class="token operator">-</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">,</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">,</span> <span class="token class-name">BasicAuthenticationFilter</span> etc <span class="token operator">-</span> so that the <span class="token class-name">SecurityContextHolder</span> can be modified <span class="token keyword">to</span> <span class="token namespace">contain</span> a valid <span class="token class-name">Authentication</span> request token
<span class="token class-name">The</span> <span class="token class-name">SecurityContextHolderAwareRequestFilter</span><span class="token punctuation">,</span> <span class="token keyword">if</span> you are using it <span class="token keyword">to</span> <span class="token namespace">install</span> a <span class="token class-name">Spring</span> <span class="token class-name">Security</span> aware <span class="token class-name">HttpServletRequestWrapper</span> into your servlet container
<span class="token class-name">The</span> <span class="token class-name">JaasApiIntegrationFilter</span><span class="token punctuation">,</span> <span class="token keyword">if</span> a <span class="token class-name">JaasAuthenticationToken</span> is in the <span class="token class-name">SecurityContextHolder</span> <span class="token keyword">this</span> will process the <span class="token class-name">FilterChain</span> as the <span class="token class-name">Subject</span> in the <span class="token class-name">JaasAuthenticationToken</span>
<span class="token class-name">RememberMeAuthenticationFilter</span><span class="token punctuation">,</span> so that <span class="token keyword">if</span> no earlier authentication processing mechanism updated the <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">,</span> and the request presents a cookie that enables remember<span class="token operator">-</span>me services <span class="token keyword">to</span> <span class="token namespace">take</span> place<span class="token punctuation">,</span> a suitable remembered <span class="token class-name">Authentication</span> object will be put there
<span class="token class-name">AnonymousAuthenticationFilter</span><span class="token punctuation">,</span> so that <span class="token keyword">if</span> no earlier authentication processing mechanism updated the <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">,</span> an anonymous <span class="token class-name">Authentication</span> object will be put there
<span class="token class-name">ExceptionTranslationFilter</span><span class="token punctuation">,</span> <span class="token keyword">to</span> <span class="token keyword">catch</span> any <span class="token class-name">Spring</span> <span class="token class-name">Security</span> exceptions so that either an HTTP error response can be returned or an appropriate <span class="token class-name">AuthenticationEntryPoint</span> can be launched
<span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">,</span> <span class="token keyword">to</span> <span class="token namespace">protect</span> web <span class="token class-name">URIs</span> and raise exceptions when access is denied
</code></pre></div><h2 id="httpsecurity"><a href="#httpsecurity" class="header-anchor">#</a> HttpSecurity</h2> <p>demo</p> <div class="language-java extra-class"><pre class="language-java"><code> http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//åŒ¹é…åˆ°çš„æ”¾è¡Œ</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="userdetailsservice"><a href="#userdetailsservice" class="header-anchor">#</a> UserDetailsService</h2> <p>è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘</p> <blockquote><p>UserDetails loadUserByUsername(String username)</p></blockquote> <p>User--&gt;å®ç°äº† UserDetails, æ–¹æ³•ç›´æ¥è¿”å› User å¯¹è±¡å³å¯</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç”¨æˆ·å: &quot;</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//.....</span>
        <span class="token comment">//æ•°æ®åº“ è·å–ç”¨æˆ·ä¿¡æ¯</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;admin,user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="passwordencoder"><a href="#passwordencoder" class="header-anchor">#</a> PasswordEncoder</h2> <p>å®šä¹‰åŠ å¯†/åŒ¹é…è§„åˆ™</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="è‡ªå®šä¹‰ç™»å½•"><a href="#è‡ªå®šä¹‰ç™»å½•" class="header-anchor">#</a> è‡ªå®šä¹‰ç™»å½•</h2> <p>ç™»é™†æˆåŠŸ: AuthenticationSuccessHandler, Authentication å¯¹è±¡åŒ…å« UserDetails çš„ä¿¡æ¯
ç™»å½•å¤±è´¥: AuthenticationFailureHandler</p> <h2 id="è®¤è¯æµç¨‹"><a href="#è®¤è¯æµç¨‹" class="header-anchor">#</a> è®¤è¯æµç¨‹</h2> <div class="language- extra-class"><pre><code>1. UsernamePasswordAuthenticationFilter æ‹¦æˆªç”¨æˆ·è¯·æ±‚
2. UsernamePasswordAuthenticationToken å°è£…ç”¨æˆ·ä¿¡æ¯
3. AuthenticationManager ç®¡ç†ä¸€ç³»åˆ—çš„AuthenticationProvider
4. AuthenticationProvider è‡ªåŠ¨å¤„ç†ä¸åŒçš„è®¤è¯ç±»å‹(æ™®é€šç™»å½•, çŸ­ä¿¡, ....), æ£€æŸ¥userdetailæ˜¯å¦å¯ç”¨...., æ£€æŸ¥å¯†ç åŒ¹é…, æ£€æŸ¥å…¨éƒ½é€šè¿‡ä»¥å,UsernamePasswordAuthenticationToken.setAuthenticated(true), é€šè¿‡è®¤è¯
5. æœ€ç»ˆè¿‡æ»¤å™¨é“¾è¿”å›ä¸€ä¸ªå·²è®¤è¯çš„ Authenticationå¯¹è±¡
6. è®¤è¯æˆåŠŸHandlerå¤„ç†
7. åŒä¸€ä¸ªè¯·æ±‚ä¸‹,å¯ä»¥é€šè¿‡ SecurityContextHolder è·å–ç”¨æˆ·è®¤è¯ä¿¡æ¯
</code></pre></div><h2 id="è‡ªå®šä¹‰è®¤è¯"><a href="#è‡ªå®šä¹‰è®¤è¯" class="header-anchor">#</a> è‡ªå®šä¹‰è®¤è¯</h2> <p>AuthenticationFilter:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsCodeAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> <span class="token punctuation">{</span>
	<span class="token comment">// ~ Static fields/initializers</span>
	<span class="token comment">// =====================================================================================</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> mobileParameter <span class="token operator">=</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DEFAULT_PARAMETER_NAME_MOBILE<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> postOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

	<span class="token comment">// ~ Constructors</span>
	<span class="token comment">// ===================================================================================================</span>

	<span class="token keyword">public</span> <span class="token class-name">SmsCodeAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DEFAULT_SIGN_IN_PROCESSING_URL_MOBILE<span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ~ Methods</span>
	<span class="token comment">// ========================================================================================================</span>

	<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication method not supported: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">String</span> mobile <span class="token operator">=</span> <span class="token function">obtainMobile</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mobile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mobile <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		mobile <span class="token operator">=</span> mobile<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">SmsCodeAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Allow subclasses to set the &quot;details&quot; property</span>
		<span class="token function">setDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">/**
	 * è·å–æ‰‹æœºå·
	 */</span>
	<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">obtainMobile</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>mobileParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * Provided so that subclasses may configure what is put into the
	 * authentication request's details property.
	 *
	 * @param request
	 *            that an authentication request is being created for
	 * @param authRequest
	 *            the authentication request object that should have its details
	 *            set
	 */</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">SmsCodeAuthenticationToken</span> authRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		authRequest<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * Sets the parameter name which will be used to obtain the username from
	 * the login request.
	 *
	 * @param usernameParameter
	 *            the parameter name. Defaults to &quot;username&quot;.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMobileParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> usernameParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>usernameParameter<span class="token punctuation">,</span> <span class="token string">&quot;Username parameter must not be empty or null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>mobileParameter <span class="token operator">=</span> usernameParameter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">/**
	 * Defines whether only HTTP POST requests will be allowed by this filter.
	 * If set to true, and an authentication request is received which is not a
	 * POST request, an exception will be raised immediately and authentication
	 * will not be attempted. The &lt;tt&gt;unsuccessfulAuthentication()&lt;/tt&gt; method
	 * will be called as if handling a failed authentication.
	 * &lt;p&gt;
	 * Defaults to &lt;tt&gt;true&lt;/tt&gt; but may be overridden by subclasses.
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPostOnly</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> postOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">=</span> postOnly<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token function">getMobileParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> mobileParameter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>AuthenticationProvider:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsCodeAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * (non-Javadoc)
	 *
	 * @see org.springframework.security.authentication.AuthenticationProvider#
	 * authenticate(org.springframework.security.core.Authentication)
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>

		<span class="token class-name">SmsCodeAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">;</span>

		<span class="token class-name">UserDetails</span> user <span class="token operator">=</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">SmsCodeAuthenticationToken</span> authenticationResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		authenticationResult<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> authenticationResult<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * (non-Javadoc)
	 *
	 * @see org.springframework.security.authentication.AuthenticationProvider#
	 * supports(java.lang.Class)
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> userDetailsService<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDetailsService</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsService <span class="token operator">=</span> userDetailsService<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>AuthenticationToken:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsCodeAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span>SERIAL_VERSION_UID<span class="token punctuation">;</span>

	<span class="token comment">// ~ Instance fields</span>
	<span class="token comment">// ================================================================================================</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

	<span class="token comment">// ~ Constructors</span>
	<span class="token comment">// ===================================================================================================</span>

	<span class="token comment">/**
	 * This constructor can be safely used by any code that wishes to create a
	 * &lt;code&gt;UsernamePasswordAuthenticationToken&lt;/code&gt;, as the {@link #isAuthenticated()}
	 * will return &lt;code&gt;false&lt;/code&gt;.
	 *
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> mobile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> mobile<span class="token punctuation">;</span>
		<span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * This constructor should only be used by &lt;code&gt;AuthenticationManager&lt;/code&gt; or
	 * &lt;code&gt;AuthenticationProvider&lt;/code&gt; implementations that are satisfied with
	 * producing a trusted (i.e. {@link #isAuthenticated()} = &lt;code&gt;true&lt;/code&gt;)
	 * authentication token.
	 *
	 * @param principal
	 * @param credentials
	 * @param authorities
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">SmsCodeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// must use super, as we override</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ~ Methods</span>
	<span class="token comment">// ========================================================================================================</span>

	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>isAuthenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
					<span class="token string">&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é…ç½®:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsCodeAuthenticationSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurerAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">,</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> testAuthenticationSuccessHandler<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> testAuthenticationFailureHandler<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">PersistentTokenRepository</span> persistentTokenRepository<span class="token punctuation">;</span>

	<span class="token comment">/* (non-Javadoc)
	 * @see org.springframework.security.config.annotation.SecurityConfigurerAdapter#configure(org.springframework.security.config.annotation.SecurityBuilder)
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

		<span class="token class-name">SmsCodeAuthenticationFilter</span> smsCodeAuthenticationFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCodeAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		smsCodeAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		smsCodeAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>testAuthenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		smsCodeAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>testAuthenticationFailureHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> key <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		smsCodeAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setRememberMeServices</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersistentTokenBasedRememberMeServices</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userDetailsService<span class="token punctuation">,</span> persistentTokenRepository<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">SmsCodeAuthenticationProvider</span> smsCodeAuthenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsCodeAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		smsCodeAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>smsCodeAuthenticationProvider<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">addFilterAfter</span><span class="token punctuation">(</span>smsCodeAuthenticationFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="æˆæƒ"><a href="#æˆæƒ" class="header-anchor">#</a> æˆæƒ</h2> <p>æˆæƒè¡¨è¾¾å¼:</p> <p><img src="/Notes/assets/img/role.f34ff2be.png" alt="æˆæƒ"></p> <h2 id="shiro"><a href="#shiro" class="header-anchor">#</a> Shiro</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;hashedCredentialsMatcher&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">HashedCredentialsMatcher</span> <span class="token function">hashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashedCredentialsMatcher</span> credentialsMatcher <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">HashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æŒ‡å®šåŠ å¯†æ–¹å¼ä¸ºMD5</span>
        credentialsMatcher<span class="token punctuation">.</span><span class="token function">setHashAlgorithmName</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åŠ å¯†æ¬¡æ•°</span>
        credentialsMatcher<span class="token punctuation">.</span><span class="token function">setHashIterations</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        credentialsMatcher<span class="token punctuation">.</span><span class="token function">setStoredCredentialsHexEncoded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> credentialsMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;userRealm&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">UserRealm</span> <span class="token function">userRealm</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;hashedCredentialsMatcher&quot;</span><span class="token punctuation">)</span>
                               <span class="token class-name">HashedCredentialsMatcher</span> matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">UserRealm</span> userRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRealm<span class="token punctuation">.</span><span class="token function">setCredentialsMatcher</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userRealm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ShiroFilterFactoryBean</span> <span class="token function">shirFilter</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;securityManager&quot;</span><span class="token punctuation">)</span>
                               <span class="token class-name">DefaultWebSecurityManager</span> securityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ShiroFilterFactoryBean</span> bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½® SecurityManager</span>
        bean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// è®¾ç½®ç™»å½•æˆåŠŸè·³è½¬Url</span>
        bean<span class="token punctuation">.</span><span class="token function">setSuccessUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®ç™»å½•è·³è½¬Url</span>
        bean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/toLogin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®æœªæˆæƒæç¤ºUrl</span>
        bean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/error/unAuth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * anonï¼šåŒ¿åç”¨æˆ·å¯è®¿é—®
         * authcï¼šè®¤è¯ç”¨æˆ·å¯è®¿é—®
         * userï¼šä½¿ç”¨rememberMeå¯è®¿é—®
         * permsï¼šå¯¹åº”æƒé™å¯è®¿é—®
         * roleï¼šå¯¹åº”è§’è‰²æƒé™å¯è®¿é—®
         **/</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;authc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/vip/index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;roles[vip]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/druid/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/static/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;authc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * æ³¨å…¥ securityManager
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;securityManager&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultWebSecurityManager</span> <span class="token function">getDefaultWebSecurityManager</span><span class="token punctuation">(</span>
        <span class="token class-name">HashedCredentialsMatcher</span> hashedCredentialsMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">DefaultWebSecurityManager</span> securityManager <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…³è”realm.</span>
        securityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span><span class="token function">userRealm</span><span class="token punctuation">(</span>hashedCredentialsMatcher<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> securityManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Realm:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç”¨æˆ·æˆæƒ
     **/</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthorizationInfo</span> <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span>
        <span class="token class-name">PrincipalCollection</span> principalCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===æ‰§è¡Œæˆæƒ===&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserBean</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserBean</span><span class="token punctuation">)</span>subject<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">SimpleAuthorizationInfo</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthorizationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è§’è‰²ä¸æƒé™å­—ç¬¦ä¸²é›†åˆ</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> rolesCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> premissionCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// è¯»å–å¹¶èµ‹å€¼ç”¨æˆ·è§’è‰²ä¸æƒé™</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleBean</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">RoleBean</span> role <span class="token operator">:</span> roles<span class="token punctuation">)</span><span class="token punctuation">{</span>
                rolesCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionBean</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> role<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PermissionBean</span> permission <span class="token operator">:</span> permissions<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    premissionCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                info<span class="token punctuation">.</span><span class="token function">addStringPermissions</span><span class="token punctuation">(</span>premissionCollection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            info<span class="token punctuation">.</span><span class="token function">addRoles</span><span class="token punctuation">(</span>rolesCollection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * ç”¨æˆ·è®¤è¯
     **/</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationInfo</span> <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span>
        <span class="token class-name">AuthenticationToken</span> authenticationToken<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===æ‰§è¡Œè®¤è¯===&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">UsernamePasswordToken</span> token <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">)</span>authenticationToken<span class="token punctuation">;</span>
        <span class="token class-name">UserBean</span> bean <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownAccountException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ByteSource</span> credentialsSalt <span class="token operator">=</span> <span class="token class-name">ByteSource</span><span class="token punctuation">.</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                credentialsSalt<span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¨¡æ‹ŸShiroç”¨æˆ·åŠ å¯†ï¼Œå‡è®¾ç”¨æˆ·å¯†ç ä¸º123456</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// ç”¨æˆ·å</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// ç”¨æˆ·å¯†ç </span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ å¯†æ–¹å¼</span>
        <span class="token class-name">String</span> hashAlgorithName <span class="token operator">=</span> <span class="token string">&quot;MD5&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hashIterations <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteSource</span> credentialsSalt <span class="token operator">=</span> <span class="token class-name">ByteSource</span><span class="token punctuation">.</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleHash</span><span class="token punctuation">(</span>hashAlgorithName<span class="token punctuation">,</span> password<span class="token punctuation">,</span>
                                    credentialsSalt<span class="token punctuation">,</span> hashIterations<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="google-authenticator"><a href="#google-authenticator" class="header-anchor">#</a> Google Authenticator</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoogleAuthenticator</span> <span class="token punctuation">{</span>

    <span class="token comment">// å¯†é’¥é•¿åº¦</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SECRET_SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token comment">// è®¡æ—¶å™¨ç§å­</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SEED <span class="token operator">=</span> <span class="token string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// éšæœºæ•°ç®—æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RANDOM_NUMBER_ALGORITHM <span class="token operator">=</span> <span class="token string">&quot;SHA1PRNG&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// æ—¶é—´çª—å£</span>
    <span class="token keyword">int</span> window_size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 3--17</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWindowSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">&lt;=</span> <span class="token number">17</span><span class="token punctuation">)</span>
            window_size <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


	<span class="token comment">// ç”Ÿæˆå¯†é’¥</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecureRandom</span> sr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sr <span class="token operator">=</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>RANDOM_NUMBER_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sr<span class="token punctuation">.</span><span class="token function">setSeed</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>SEED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">generateSeed</span><span class="token punctuation">(</span>SECRET_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Base32</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Base32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bEncodedKey <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> encodedKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bEncodedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> encodedKey<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç”ŸæˆäºŒç»´ç url</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getQRBarcodeURL</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> format <span class="token operator">=</span> <span class="token string">&quot;http://www.google.com/chart?chs=200x200&amp;chld=M%%7C0&amp;cht=qr&amp;chl=otpauth://totp/%s@%s?secret=%s&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> user<span class="token punctuation">,</span> host<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// äºŒç»´ç å†…å®¹</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getQRBarcode</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> format <span class="token operator">=</span> <span class="token string">&quot;otpauth://totp/%s?secret=%s&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> user<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// éªŒè¯ code</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">check_code</span><span class="token punctuation">(</span><span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token keyword">long</span> code<span class="token punctuation">,</span> <span class="token keyword">long</span> timeMsec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Base32</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Base32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decodedKey <span class="token operator">=</span> codec<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>timeMsec <span class="token operator">/</span> <span class="token number">1000L</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">30L</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token operator">-</span>window_size<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> window_size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> hash<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                hash <span class="token operator">=</span> <span class="token function">verify_code</span><span class="token punctuation">(</span>decodedKey<span class="token punctuation">,</span> t <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">==</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// éªŒè¯codeçš„å…·ä½“ç®—æ³•</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">verify_code</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> value <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> value <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">SecretKeySpec</span> signKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;HmacSHA1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mac</span> mac <span class="token operator">=</span> <span class="token class-name">Mac</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;HmacSHA1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>signKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hash <span class="token operator">=</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> offset <span class="token operator">=</span> hash<span class="token punctuation">[</span><span class="token number">20</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xF</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> truncatedHash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            truncatedHash <span class="token operator">&lt;&lt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            truncatedHash <span class="token operator">|=</span> <span class="token punctuation">(</span>hash<span class="token punctuation">[</span>offset <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        truncatedHash <span class="token operator">&amp;=</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">;</span>
        truncatedHash <span class="token operator">%=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> truncatedHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">6 ä¸ªæœˆå‰</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/Notes/java/cloud.html" class="prev">
        Spring Cloud â˜ï¸ (alibaba)
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Notes/assets/js/app.269e44a0.js" defer></script><script src="/Notes/assets/js/2.cc402b5a.js" defer></script><script src="/Notes/assets/js/6.f5678ca0.js" defer></script>
  </body>
</html>
